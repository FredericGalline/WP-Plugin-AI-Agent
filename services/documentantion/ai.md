# AI Redactor - Documentation technique

Ce fichier documente l'architecture et le fonctionnement du plugin **AI Redactor**, en particulier le syst√®me de requ√™tage vers les diff√©rentes API d'intelligence artificielle.

## ‚ú® Objectif

Permettre √† un d√©veloppeur de comprendre rapidement comment sont g√©r√©es les requ√™tes vers les IA, comment ajouter un nouveau fournisseur, et comment diagnostiquer une erreur.

---

## ‚åö Arborescence concern√©e

```
/ai
‚îú‚îÄ‚îÄ ai-loader.php
‚îú‚îÄ‚îÄ core/
‚îÇ   ‚îî‚îÄ‚îÄ ai-request-handler.php      ‚ûî Point d'entr√©e central des requ√™tes IA
‚îú‚îÄ‚îÄ api/
‚îÇ   ‚îú‚îÄ‚îÄ OpenAI.php               ‚ûî Classe AI_OpenAI_API
‚îÇ   ‚îú‚îÄ‚îÄ Anthropic.php           ‚ûî Classe AI_Anthropic_API
‚îÇ   ‚îú‚îÄ‚îÄ Gemini.php              ‚ûî Classe AI_Gemini_API
‚îÇ   ‚îú‚îÄ‚îÄ Mistral.php             ‚ûî Classe AI_Mistral_API
‚îÇ   ‚îî‚îÄ‚îÄ Grok.php                ‚ûî Classe AI_Grok_API
‚îú‚îÄ‚îÄ providers-config.php           ‚ûî Configuration des fournisseurs et mod√®les
‚îú‚îÄ‚îÄ ui/
‚îÇ   ‚îî‚îÄ‚îÄ ai-admin-tester.php      ‚ûî Interface admin pour tester un prompt
‚îú‚îÄ‚îÄ diagnostic.php                 ‚ûî Outil de diagnostic manuel complet
```

---

## üõ†Ô∏è Architecture

### 1. `AI_Request_Handler` (core/ai-request-handler.php)

- **M√©thode principale** : `send_prompt($prompt)`
- Elle :
  - lit le mod√®le actif dans `get_option('ai_agent_active_model')` (format `provider:model`)
  - lit la cl√© API correspondante dans la config
  - d√©l√®gue la requ√™te √† la classe du provider via :

```php
$class = 'AI_' . ucfirst($active_provider) . '_API';
return $class::send_request($prompt, $model, $api_key);
```

- Elle g√®re aussi les cas d'erreur (provider inconnu, mod√®le non configur√©, cl√© API manquante).

### 2. Classes individuelles par provider (dossier `/api/`)

Chaque classe impl√©mente une m√©thode statique `send_request($prompt, $model, $api_key)` qui :
- construit l'URL et le body sp√©cifique √† l'API
- utilise `wp_remote_post()`
- parse la r√©ponse selon la structure de l'API (OpenAI, Claude, Gemini, etc.)
- retourne un tableau associatif :

```php
[
  'success' => true|false,
  'response' => 'texte g√©n√©r√©' ou tableau brut,
  'error' => 'message si erreur'
]
```

---

## üìù Guide complet pour effectuer des requ√™tes IA

### Configuration pr√©alable

Avant de pouvoir envoyer des requ√™tes, assurez-vous que :

1. Un mod√®le d'IA est correctement configur√© dans l'option `ai_agent_active_model` au format `provider:model`
2. Une cl√© API valide est enregistr√©e dans l'option correspondante (ex: `ai_redactor_openai_api_key`)
3. Le fournisseur et le mod√®le sont correctement r√©f√©renc√©s dans `providers-config.php`

### √âtapes pour envoyer une requ√™te IA

#### 1. Pr√©paration du prompt

```php
// Formatez votre prompt selon vos besoins
$prompt = "Voici un article sur [SUJET]. Peux-tu am√©liorer son style ?";
$prompt .= "\n\nContenu original:\n" . $content;

// Si n√©cessaire, ajoutez des instructions sp√©cifiques
$prompt .= "\n\nInstructions: Conserve le message principal, mais am√©liore le style et la clart√©.";
```

#### 2. Envoi du prompt via le gestionnaire central

```php
// Inclure le gestionnaire de requ√™tes si n√©cessaire
require_once PLUGIN_PATH . '/services/ai/core/ai-request-handler.php';

// Mesurer le temps de r√©ponse (optionnel)
$start_time = microtime(true);

// Envoyer la requ√™te
$result = AI_Request_Handler::send_prompt($prompt);

// Calcul du temps de r√©ponse (optionnel)
$response_time = microtime(true) - $start_time;
```

#### 3. Traitement de la r√©ponse

```php
// V√©rifier si la requ√™te a r√©ussi
if ($result['success']) {
    // Acc√©der √† la r√©ponse g√©n√©r√©e
    $ai_response = $result['response'];
    
    // Utiliser la r√©ponse (par exemple, l'afficher ou la sauvegarder)
    echo '<div class="ai-response">' . esc_html($ai_response) . '</div>';
    
    // Journaliser le succ√®s (optionnel)
    if (function_exists('ai_agent_log')) {
        ai_agent_log('Requ√™te IA r√©ussie - Longueur: ' . strlen($ai_response) . ' caract√®res', 'info');
    }
} else {
    // G√©rer l'erreur
    $error_message = $result['error'];
    
    // Afficher un message d'erreur √† l'utilisateur
    echo '<div class="ai-error">Erreur: ' . esc_html($error_message) . '</div>';
    
    // Journaliser l'erreur (optionnel)
    if (function_exists('ai_agent_log')) {
        ai_agent_log('Erreur requ√™te IA: ' . $error_message, 'error');
    }
}
```

### Gestion des erreurs communes

1. **Mod√®le non configur√©** :
   - V√©rifiez que `get_option('ai_agent_active_model')` retourne une valeur au format `provider:model`
   - Solution : configurez un mod√®le dans l'interface admin

2. **Cl√© API manquante** :
   - V√©rifiez que la cl√© associ√©e au fournisseur est enregistr√©e
   - Solution : ajoutez la cl√© API dans les param√®tres de connecteurs IA

3. **Erreur d'API externe** :
   - Les erreurs des fournisseurs (quotas, probl√®mes de r√©seau, etc.) sont captur√©es dans `$result['error']`
   - Solution : v√©rifiez les limites de votre compte et la connectivit√© r√©seau

4. **Timeout** :
   - Les mod√®les volumineux peuvent d√©passer le temps d'ex√©cution PHP par d√©faut
   - Solution : utilisez `set_time_limit(180)` avant les appels longs

### Exemple de cas d'utilisation avanc√©

```php
// Augmenter temporairement la limite de temps d'ex√©cution
$original_time_limit = ini_get('max_execution_time');
set_time_limit(180); // 3 minutes

try {
    // Envoyer la requ√™te
    $result = AI_Request_Handler::send_prompt($prompt);
    
    if ($result['success']) {
        // Traiter la r√©ponse r√©ussie
        update_post_meta($post_id, '_ai_enhanced_content', $result['response']);
        
        // Notifier l'utilisateur du succ√®s
        add_settings_error(
            'ai_agent_processing',
            'content_enhanced',
            __('Contenu am√©lior√© avec succ√®s par l\'IA!', 'ai-agent'),
            'success'
        );
    } else {
        // G√©rer l'erreur et fournir un retour d√©taill√©
        throw new Exception($result['error']);
    }
} catch (Exception $e) {
    // Capturer toute exception
    add_settings_error(
        'ai_agent_processing',
        'ai_error',
        sprintf(__('Erreur lors du traitement IA: %s', 'ai-agent'), $e->getMessage()),
        'error'
    );
    
    // Journaliser l'erreur
    if (function_exists('ai_agent_log')) {
        ai_agent_log('EXCEPTION: ' . $e->getMessage(), 'error');
    }
} finally {
    // Restaurer la limite de temps d'origine
    set_time_limit($original_time_limit);
}
```

---

## üìö Exemple d'appel de prompt

```php
$response = AI_Request_Handler::send_prompt("Explique la gravitation quantique");

if ($response['success']) {
    echo $response['response'];
} else {
    error_log('Erreur IA : ' . $response['error']);
}
```

---

## üîç Structure de r√©ponse d√©taill√©e

Lorsque vous appelez `AI_Request_Handler::send_prompt()`, le r√©sultat est toujours un tableau avec cette structure :

```php
[
    // Indique si la requ√™te a r√©ussi (true) ou √©chou√© (false)
    'success' => true|false,
    
    // Contient la r√©ponse de l'IA si success est true
    // Peut √™tre une cha√Æne de caract√®res ou un tableau selon le fournisseur
    'response' => 'Texte de r√©ponse g√©n√©r√© par l'IA...',
    
    // Contient un message d'erreur si success est false
    // Peut aussi √™tre pr√©sent avec success=true pour les avertissements
    'error' => 'Description d√©taill√©e de l'erreur'
]
```

### Variations par fournisseur

Bien que la structure de base soit standardis√©e, certains fournisseurs peuvent ajouter des informations suppl√©mentaires :

- **OpenAI** : Peut inclure des m√©tadonn√©es comme le nombre de tokens utilis√©s
- **Anthropic** : Peut inclure des m√©tadonn√©es sur le mod√®le utilis√©
- **Gemini** : Peut contenir des informations sur la confiance de la r√©ponse

Acc√©dez √† ces informations suppl√©mentaires via le tableau `$result` :

```php
// Exemple avec OpenAI qui peut inclure des m√©tadonn√©es
if ($result['success'] && isset($result['meta'])) {
    $usage = $result['meta']['usage'] ?? [];
    $prompt_tokens = $usage['prompt_tokens'] ?? 0;
    $completion_tokens = $usage['completion_tokens'] ?? 0;
    
    echo "Tokens utilis√©s: $prompt_tokens (prompt) + $completion_tokens (r√©ponse)";
}
```

---

## ‚ö° Ajouter un nouveau fournisseur IA

1. Cr√©er un fichier dans `/api/NouveauProvider.php`
2. Nommer la classe `AI_NouveauProvider_API` avec une m√©thode `send_request()`
3. Ajouter une entr√©e dans `providers-config.php` :

```php
'nouveauprovider' => [
  'name' => 'Nouveau Provider',
  'api_key_option' => 'ai_redactor_nouveauprovider_api_key',
  'models' => [
    'modele-1' => ['label' => 'Mod√®le Standard'],
  ]
]
```

4. La classe sera appel√©e automatiquement si l'utilisateur active ce provider dans l'admin.

---

## üîß Outils de test et de diagnostic

### `ai-admin-tester.php`
- Page admin permettant de tester un prompt en live
- Affiche la r√©ponse ou l'erreur, ainsi que les temps de r√©ponse si `AI_REDACTOR_DEBUG` est activ√©

### `diagnostic.php`
- Script autonome de test :
  - v√©rifie que la config est valide
  - liste les options en base de donn√©es
  - simule l'appel √† `send_prompt()` avec message de retour explicite

### Utilisation du testeur de prompt dans l'admin
1. Acc√©dez √† `AI Agent > Testeur de Prompt` dans le menu admin WordPress
2. Entrez votre prompt dans la zone de texte
3. Cliquez sur "Tester ce Prompt"
4. Consultez la r√©ponse ou les messages d'erreur
5. En cas d'erreur, activez le diagnostic pour voir les d√©tails techniques

---

## üîé Conseils pour le d√©bogage

### Activer les logs de diagnostic
Ajoutez dans votre fichier wp-config.php :
```php
define('AI_AGENT_DEBUG', true);
```

### Consulter les logs
Les logs sont enregistr√©s dans `/logs/ai-agent.log` et contiennent :
- Requ√™tes envoy√©es
- R√©ponses re√ßues
- Erreurs et avertissements
- Performance (temps de r√©ponse)

### Probl√®mes fr√©quents et solutions
1. **"Aucun mod√®le n'est configur√©"**
   - V√©rifiez que l'option `ai_agent_active_model` est correctement d√©finie
   - Acc√©dez √† AI Agent > Connecteurs IA pour s√©lectionner un mod√®le

2. **"Format de r√©ponse invalide"**
   - V√©rifiez que la classe API du fournisseur traite correctement le format de r√©ponse
   - Consultez les logs pour voir la r√©ponse brute

3. **"Cl√© API non configur√©e"**
   - V√©rifiez que la cl√© API est bien enregistr√©e pour le fournisseur actif
   - Acc√©dez √† AI Agent > Connecteurs IA pour configurer la cl√©

---

## üéì Bonnes pratiques

- Toujours logger les erreurs si `AI_REDACTOR_DEBUG` est d√©fini.
- Ne jamais appeler directement les classes du dossier `/api/` ailleurs que via `AI_Request_Handler`.
- Ne jamais exposer les cl√©s API dans l'admin (utiliser `get_option()` uniquement c√¥t√© serveur).
- Utiliser `esc_html()`, `esc_attr()`, `sanitize_text_field()` pour toutes les entr√©es/sorties.

---

## üö´ Production

- Le fichier `diagnostic.php` **ne doit jamais √™tre d√©ploy√©** sur un environnement en ligne.
- Le plugin fonctionne m√™me si une IA est mal configur√©e, tant qu'une autre est active et valide.

---

## ‚úèÔ∏è TODO ‚Äì Am√©liorations futures possibles

- Ajouter des tests automatis√©s de chaque classe `send_request()`
- Stocker les logs dans un fichier d√©di√©
- Ajouter un syst√®me de fallback si une IA est en erreur
- Support multi-fournisseur (encha√Ænement de prompts)

---

## üöÄ Fait avec soin par l'√©quipe dev.

Version : 1.1.0
Date : Avril 2025

---
